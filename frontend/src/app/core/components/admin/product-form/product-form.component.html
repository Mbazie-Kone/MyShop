<app-loading-wrapper [loading]="loading" [spinnerSize]="'60px'" [minHeight]="'400px'">
    <form [formGroup]="productForm" (ngSubmit)="onSubmit()" enctype="multipart/form-data">
        <div class="row">
            <!-- COLUMN 1 -->
            <div class="col-lg-8 col-12">
                <!-- Card 1 -->
                <app-card customClass="custom-card-mb">
                    <!-- Card body -->
                    <div class="card-body">
                        <div>
                            <!-- Product name -->
                            <div class="mb-3">
                                <label class="form-label">Product Name</label>
                                <input class="form-control" formControlName="name" 
                                       aria-describedby="name-help"
                                       aria-required="true">
                                <div *ngIf="productForm.get('name')?.invalid && productForm.get('name')?.touched" class="text-danger">
                                    Product name is required.
                                </div>
                                <div id="name-help" class="form-text">Enter a descriptive name for your product</div>
                            </div>

                            <!-- Enhanced Product Description -->
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="form-label mb-0" for="description-field">Product Description</label>
                                    <div class="btn-group btn-group-sm" role="group" aria-label="Description actions">
                                        <button type="button" class="btn btn-outline-secondary" (click)="toggleDescriptionPreview()"
                                                title="Toggle preview (Ctrl+P)" [attr.aria-pressed]="showDescriptionPreview">
                                            <i class="icon-eye"></i> {{ showDescriptionPreview ? 'Hide' : 'Show' }} Preview
                                        </button>
                                        <button type="button" class="btn btn-outline-danger" (click)="clearDescription()"
                                                title="Clear description">
                                            <i class="icon-trash"></i> Clear
                                        </button>
                                    </div>
                                </div>

                                <!-- Description Templates -->
                                <div class="mb-3">
                                    <label class="form-label small">Quick Templates</label>
                                    <div class="d-flex flex-wrap gap-2">
                                        <button type="button" 
                                                class="btn btn-outline-primary btn-sm" 
                                                *ngFor="let template of descriptionTemplates"
                                                (click)="applyTemplate(template.template)"
                                                title="Apply {{ template.name }} template">
                                            {{ template.name }}
                                        </button>
                                    </div>
                                </div>

                                <!-- Description Editor -->
                                <div *ngIf="!showDescriptionPreview">
                                    <textarea 
                                        id="description-field"
                                        class="form-control description-editor" 
                                        rows="6" 
                                        formControlName="description"
                                        [placeholder]="descriptionPlaceholder"
                                        (input)="onDescriptionInput($event)"
                                        [class.is-invalid]="productForm.get('description')?.invalid && productForm.get('description')?.touched"
                                        [class.drag-over]="isDragOver"
                                        (dragover)="onDragOver($event)"
                                        (dragleave)="onDragLeave($event)"
                                        (drop)="onDrop($event)"
                                        aria-describedby="description-help description-counter description-suggestions"
                                        aria-required="true"
                                        [attr.aria-invalid]="productForm.get('description')?.invalid">
                                    </textarea>
                                    
                                    <!-- Character counter and status -->
                                    <div class="d-flex justify-content-between align-items-center mt-2">
                                        <small [class]="getDescriptionStatusClass()" id="description-help">
                                            <i class="icon-info-circled"></i> {{ getDescriptionStatusText() }}
                                        </small>
                                        <small [class]="descriptionLength > maxDescriptionLength ? 'text-danger' : 'text-muted'" id="description-counter">
                                            {{ descriptionLength }} / {{ maxDescriptionLength }} characters
                                        </small>
                                    </div>

                                    <!-- Smart Suggestions -->
                                    <div *ngIf="suggestions.length > 0" class="mt-2" id="description-suggestions">
                                        <div class="alert alert-info alert-sm">
                                            <h6 class="alert-heading">
                                                <i class="icon-lightbulb"></i> Suggestions to improve your description:
                                            </h6>
                                            <ul class="mb-0">
                                                <li *ngFor="let suggestion of suggestions">{{ suggestion }}</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Description Preview -->
                                <div *ngIf="showDescriptionPreview" class="border rounded p-3 bg-light">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="mb-0">Description Preview</h6>
                                        <button type="button" class="btn btn-sm btn-outline-primary" (click)="toggleDescriptionPreview()">
                                            <i class="icon-edit"></i> Edit
                                        </button>
                                    </div>
                                    <div class="description-preview">
                                        <p *ngIf="productForm.get('description')?.value; else noDescription" 
                                           [innerHTML]="productForm.get('description')?.value | nl2br">
                                        </p>
                                        <ng-template #noDescription>
                                            <p class="text-muted fst-italic">No description entered yet...</p>
                                        </ng-template>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </app-card>

                <!-- Card 2 -->
                <app-card customClass="custom-card-mb">
                    <!-- Card body -->
                    <div class="card-body">
                        <div>
                            <!-- Product image -->
                            <div class="mb-4">
                                <!-- Heading -->
                                <h5 class="mb-4">Product Gallery</h5>
                                <label class="form-label">Product Image (max 8)</label>
                                
                                <!-- Upload Progress Bar -->
                                <div *ngIf="isUploading" class="mb-3">
                                    <div class="progress">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                             role="progressbar" 
                                             [style.width.%]="uploadProgress"
                                             [attr.aria-valuenow]="uploadProgress" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                            {{ uploadProgress }}%
                                        </div>
                                    </div>
                                    <small class="text-muted">Uploading images...</small>
                                </div>

                                <!-- Drag & Drop Zone -->
                                <div class="upload-zone" 
                                     [class.drag-over]="isDragOver"
                                     (dragover)="onDragOver($event)"
                                     (dragleave)="onDragLeave($event)"
                                     (drop)="onDrop($event)">
                                    <input type="file" class="form-control" 
                                           (change)="onImageSelected($event)" 
                                           accept=".jpg,.jpeg,.png" 
                                           multiple 
                                           [disabled]="isFileInputDisabled"
                                           aria-describedby="upload-help">
                                    <div class="upload-zone-text" *ngIf="!isDragOver">
                                        <i class="icon-upload"></i>
                                        <p>Drag & drop images here or click to browse</p>
                                    </div>
                                    <div class="upload-zone-text" *ngIf="isDragOver">
                                        <i class="icon-upload"></i>
                                        <p>Drop images here to upload</p>
                                    </div>
                                </div>
                                
                                <div id="upload-help" class="form-text">
                                    Supported formats: JPG, PNG. Maximum 8 images.
                                </div>

                                <p class="mt-2">Image Preview</p>
                                <div class="mt-2 d-flex flex-wrap gap-2">
                                    <!-- Existing images (edit mode) -->
                                     <ng-container *ngIf="isEditMode">
                                        <div *ngFor="let image of existingImages" class="position-relative">
                                            <img [src]="image.url" style="width: 80px;" [alt]="'Product image ' + image.id">
                                            <button type="button" class="btn-remove-image" (click)="removeExistingImage(image.id)"
                                                    aria-label="Remove image">
                                                <i class="icon-cancel-circled"></i>
                                            </button>
                                        </div>
                                     </ng-container>
                                    <!-- Selected images to upload -->
                                     <div *ngFor="let img of imagePreviews; let i = index" class="position-relative">
                                        <img [src]="img" style="width: 80px;" [alt]="'Preview image ' + (i + 1)">
                                        <button type="button" class="btn-remove-image" (click)="removeSelectedImage(i)"
                                                aria-label="Remove preview image">
                                            <i class="icon-cancel-circled"></i>
                                        </button>
                                     </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </app-card>
            </div>

            <!-- COLUMN 2 -->
            <div class="col-lg-4 col-12">
                <!-- Card 1 -->
                <app-card customClass="custom-card-mb">
                    <div class="card-body">
                        <div>
                            <!-- Product code -->
                            <div class="mb-3">
                                <label class="form-label">Product Code</label>
                                <input class="form-control" id="productCode" formControlName="productCode">
                                <div *ngIf="productForm.get('productCode')?.touched && productForm.get('productCode')?.invalid" class="text-danger">
                                    <div *ngIf="productForm.get('productCode')?.errors?.['required']">Product code is required</div>
                                    <div *ngIf="productForm.get('productCode')?.errors?.['minlength']">Must be at leat 16 characters</div>
                                    <div *ngIf="productForm.get('productCode')?.errors?.['maxlength']">Must be no more than 16 characters</div>
                                    <div *ngIf="productForm.get('productCode')?.errors?.['pattern']">Only uppercase letters, numbers and dashes are allowed.</div>
                                </div>
                            </div>

                            <!-- Product sku -->
                            <div class="mb-3">
                                <label class="form-label">Product SKU</label>
                                <input class="form-control" id="sku" formControlName="sku">
                                <div *ngIf="productForm.get('sku')?.touched && productForm.get('sku')?.invalid" class="text-danger">
                                    <div *ngIf="productForm.get('sku')?.errors?.['required']">SKU is required.</div>
                                    <div *ngIf="productForm.get('sku')?.errors?.['minlength']">SKU must be at least 16 characters.</div>
                                    <div *ngIf="productForm.get('sku')?.errors?.['maxlength']">SKU must be no more than 16 characters.</div>
                                    <div *ngIf="productForm.get('sku')?.errors?.['pattern']">SKU must contain only uppercase letters and numbers.</div>
                                </div>
                            </div>

                            <!-- Product category -->
                            <div class="mb-3">
                                <label class="form-label">Category</label>
                                <select class="form-select" formControlName="categoryId">
                                    <option *ngFor="let category of categories" [value]="category.id">{{ category.name }}</option>
                                </select>
                                <div *ngIf="productForm.get('categoryId')?.invalid && productForm.get('categoryId')?.touched" class="text-danger">
                                    Category is required.
                                </div>
                            </div>
                        </div>
                    </div>
                </app-card>

                <!-- Card 2 -->
                <app-card customClass="custom-card-mb">
                    <div class="card-body">
                        <div>
                            <!-- Product stock -->
                            <div class="mb-3">
                                <label class="form-label">Stock</label>
                                <input type="number" class="form-control" formControlName="stock" min="0">
                                <div *ngIf="productForm.get('stock')?.hasError('min')" class="text-danger">
                                    Stock cannot be negative.
                                </div>
                            </div>

                            <!-- Product price -->
                            <div class="mb-3">
                                <label class="form-label">Regular Price</label>
                                <input type="number" class="form-control" formControlName="price" step="0.01" min="0">
                                <div *ngIf="productForm.get('price')?.hasError('required') && productForm.get('price')?.touched" class="text-danger">
                                    Price is required.
                                </div>
                                <div *ngIf="productForm.get('price')?.hasError('min')" class="text-danger">
                                    Price must be 0 or greater.
                                </div>
                                <div *ngIf="productForm.get('price')?.touched && productForm.get('price')?.hasError('pattern')" class="text-danger">
                                    Price must be a valid Euro amount (e.g. 10.99).
                                </div>
                            </div>
                        </div>
                    </div>
                </app-card>

                <!-- Submit -->
                 <div class="d-grid">
                    <button class="btn btn-success" type="submit" [disabled]="productForm.invalid || saving">
                        <span *ngIf="saving">
                            <app-spinner size="16px"></app-spinner>
                            Saving...
                        </span>
                        <span *ngIf="!saving">{{ isEditMode ? 'Update' : 'Add' }} Product</span>
                    </button>
                 </div>

                 <!-- Keyboard Shortcuts Help -->
                 <div class="mt-3">
                     <small class="text-muted">
                         <strong>Keyboard shortcuts:</strong><br>
                         Ctrl+P: Toggle preview<br>
                         Ctrl+S: Save product
                     </small>
                 </div>
            </div>
        </div>  
    </form>
</app-loading-wrapper>

<!-- TOAST -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100;" *ngIf="showToast">
    <div class="toast align-items-center text-white bg-success border-o show" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                Product {{ isEditMode ? 'updated' : 'added' }} successfully!
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" (click)="showToast = false" aria-label="Close"></button>
        </div>
    </div>
</div>